# This file contains the fastlane.tools configuration
# You can find the documentation at https://docs.fastlane.tools
#
# For a list of all available actions, check out
#
#     https://docs.fastlane.tools/actions
#
# For a list of all available plugins, check out
#
#     https://docs.fastlane.tools/plugins/available-plugins
#

# Uncomment the line if you want fastlane to automatically update itself
# update_fastlane

default_platform(:ios)

# é¡¹ç›®ID
project_identifier = "com.yzj.XCodeGitHub"
# é¡¹ç›®çš„å†…æµ‹schemeåç§°
project_ad_scheme = "XCodeGitHub"
# é¡¹ç›®çš„å‘å¸ƒschemeåç§°
project_release_scheme = "XCodeGitHub"
# é¡¹ç›®çš„å†…æµ‹æè¿°æ–‡ä»¶åç§°
project_ad_provisioningProfiles = "XCodeGitHubProfile"
# é¡¹ç›®çš„å‘å¸ƒæè¿°æ–‡ä»¶åç§°
#project_release_provisioningProfiles = "tyfocgApp_release_0516"

# é»˜è®¤å†…æµ‹æ‰“åŒ…æ–¹å¼ï¼Œç›®å‰æ”¯æŒapp-store, package, ad-hoc, enterprise, development
# æ³¨:ç”±äºå¦‚æœä½¿ç”¨æ‰‹åŠ¨é…ç½®è¯ä¹¦ï¼Œåœ¨export_optionsæŒ‡å®šæ‰“åŒ…æ–¹å¼ï¼
ipa_exportMethod = "ad-hoc"
# .ipaæ–‡ä»¶è¾“å‡ºè·¯å¾„
ipa_output_Directory = "~/Desktop/fastlaneBuild"

# è’²å…¬è‹±api_keyå’Œuser_key
pgyer_apiKey  = "220bbf8b1c0d2bb1e352921a4af23a68"
pgyer_userkey = "975ebab8ab6652be5b845704695c1877"

# è®¡ç®—buildNumber
def updateProjectBuildNumber
    currentTime = Time.new.strftime("%Y%m%d")
    build = get_build_number()
    if build.include?"#{currentTime}."
    # => ä¸ºå½“å¤©ç‰ˆæœ¬ è®¡ç®—è¿­ä»£ç‰ˆæœ¬å·
    lastStr = build[build.length-2..build.length-1]
    lastNum = lastStr.to_i
    lastNum = lastNum + 1
    lastStr = lastNum.to_s
    if lastNum < 10
    lastStr = lastStr.insert(0,"0")
    end
    build = "#{currentTime}.#{lastStr}"
    else
    # => éå½“å¤©ç‰ˆæœ¬ build å·é‡ç½®
    build = "#{currentTime}.01"
    end
    puts("*************| æ›´æ–°build #{build} |*************")
    # => æ›´æ”¹é¡¹ç›® build å·
    increment_build_number(
        build_number: "#{build}"
    )
end

platform :ios do

	 # ----------------------- æ‰“åŒ…å†…æµ‹.ipaæ–‡ä»¶ -----------------------
    desc "ä¸Šä¼ æµ‹è¯•ç‰ˆæœ¬åˆ°è’²å…¬è‹±"
    lane :adhoc do|options|
    branch = options[:branch]

        puts "*************| å¼€å§‹æ‰“åŒ….ipaæ–‡ä»¶... |*************"

        # æ›´æ–°é¡¹ç›®buildå·
        updateProjectBuildNumber

        # å¼€å§‹æ‰“åŒ…
        gym(
            # æŒ‡å®šè¾“å‡ºçš„ipaåç§°
            output_name:"#{project_ad_scheme}_#{get_build_number()}",
            # æŒ‡å®šé¡¹ç›®çš„scheme
            scheme:"#{project_ad_scheme}",
            # æ˜¯å¦æ¸…ç©ºä»¥å‰çš„ç¼–è¯‘ä¿¡æ¯ trueï¼šæ˜¯
            clean:true,
            # æŒ‡å®šæ‰“åŒ…æ–¹å¼ï¼ŒRelease æˆ–è€… Debug
            configuration:"Release",
            # æŒ‡å®šæ‰“åŒ…æ–¹å¼ï¼Œç›®å‰æ”¯æŒapp-store, package, ad-hoc, enterprise, development
            # æ³¨:ç”±äºä½¿ç”¨æ‰‹åŠ¨é…ç½®è¯ä¹¦ï¼Œåœ¨export_optionsæŒ‡å®šæ‰“åŒ…æ–¹å¼
            #export_method:"#{ipa_exportMethod}",
            # æŒ‡å®šè¾“å‡ºæ–‡ä»¶å¤¹
            output_directory:"#{ipa_output_Directory}",
            # Xcode9å°†ä¸ä¼šå…è®¸ä½ è®¿é—®é’¥åŒ™ä¸²é‡Œçš„å†…å®¹ï¼Œé™¤éè®¾ç½®allowProvisioningUpdates
            export_xcargs:"-allowProvisioningUpdates",
            # éšè—æ²¡æœ‰å¿…è¦çš„ä¿¡æ¯
            silent:true,
            # æ‰‹åŠ¨é…ç½®è¯ä¹¦,æ³¨æ„æ‰“åŒ…æ–¹å¼éœ€åœ¨export_optionså†…ä½¿ç”¨methodè®¾ç½®ï¼Œä¸å¯ä½¿ç”¨export_method
            export_options: {
                method:"#{ipa_exportMethod}",
                provisioningProfiles: {
                    "#{project_identifier}":"#{project_ad_provisioningProfiles}"
                },
            }
        )
        puts "*************| å¼€å§‹ä¸Šä¼ è’²å…¬è‹±... |*************"
        # å¼€å§‹ä¸Šä¼ è’²å…¬è‹±
        #, user_key: "#{pgyer_userkey}" , update_description: "#{options[:desc]}
        pgyer(api_key: "#{pgyer_apiKey}", install_type: "1")
        puts "*************| ä¸Šä¼ è’²å…¬è‹±æˆåŠŸğŸ‰ |*************"
    end

  desc "Push a new release build to the App Store"
  lane :release do
    increment_build_number(xcodeproj: "XCodeGitHub.xcodeproj")
    build_app(scheme: "XCodeGitHub")
    upload_to_app_store
  end
end
